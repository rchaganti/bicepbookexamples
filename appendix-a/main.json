{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "15725060221270891511"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources."
      }
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Specifies the name of the Azure Storage account."
      }
    },
    "storageFileShareName": {
      "type": "string",
      "defaultValue": "temp",
      "metadata": {
        "description": "Specifies the SMB share name for sharing files between nodes."
      }
    },
    "numCP": {
      "type": "int",
      "defaultValue": 1,
      "allowedValues": [
        1,
        3,
        5
      ],
      "metadata": {
        "description": "Number of control plane VMs."
      }
    },
    "numWorker": {
      "type": "int",
      "defaultValue": 3,
      "minValue": 1,
      "metadata": {
        "description": "Number of worker VMs."
      }
    },
    "username": {
      "type": "string",
      "defaultValue": "ubuntu",
      "metadata": {
        "description": "Username for the Linux VM"
      }
    },
    "authenticationType": {
      "type": "string",
      "defaultValue": "password",
      "metadata": {
        "description": "Type of authentication to use on the Virtual Machine. SSH key is recommended."
      }
    },
    "passwordOrKey": {
      "type": "securestring",
      "metadata": {
        "description": "SSH Key or password for the Virtual Machine. SSH key is recommended."
      }
    },
    "cniPlugin": {
      "type": "string",
      "defaultValue": "calico",
      "metadata": {
        "description": "CNI plugin to install."
      }
    },
    "cniCidr": {
      "type": "string",
      "defaultValue": "10.244.0.0/16",
      "metadata": {
        "description": "CNI Pod Network CIDR."
      }
    }
  },
  "variables": {
    "copy": [
      {
        "name": "cpVmNames",
        "count": "[length(range(0, parameters('numCP')))]",
        "input": {
          "name": "[format('cplane{0}', add(range(0, parameters('numCP'))[copyIndex('cpVmNames')], 1))]",
          "role": "cp"
        }
      },
      {
        "name": "workerVmNames",
        "count": "[length(range(0, parameters('numWorker')))]",
        "input": {
          "name": "[format('worker{0}', add(range(0, parameters('numWorker'))[copyIndex('workerVmNames')], 1))]",
          "role": "worker"
        }
      }
    ],
    "vmObject": "[concat(variables('cpVmNames'), variables('workerVmNames'))]",
    "commonPrerequisiteConfig": "#!/bin/sh\n\n# update an upgrade package list and install curl\napt-get update\napt-get -y upgrade\napt-get install -y apt-transport-https ca-certificates curl\n\n# Disable swap\nswapoff -a\nsed -i '/ swap / s/^\\(.*\\)$/#\\1/g' /etc/fstab\n\n# Enable br_netfilter\ncat <<EOF | sudo tee /etc/modules-load.d/k8s.conf\noverlay\nbr_netfilter\nEOF\n\nmodprobe overlay\nmodprobe br_netfilter\n\n# sysctl params required by setup, params persist across reboots\ncat <<EOF | sudo tee /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-iptables  = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.ipv4.ip_forward                 = 1\nEOF\n\n# Apply sysctl params without reboot\nsysctl --system\n\n# Install Containerd\ncurl -Lo /tmp/containerd-1.6.9-linux-amd64.tar.gz https://github.com/containerd/containerd/releases/download/v1.6.9/containerd-1.6.9-linux-amd64.tar.gz\ntar Cxzvf /usr/local /tmp/containerd-1.6.9-linux-amd64.tar.gz\n\ncurl -Lo /tmp/runc.amd64 https://github.com/opencontainers/runc/releases/download/v1.1.4/runc.amd64\ninstall -m 755 /tmp/runc.amd64 /usr/local/sbin/runc\n\ncurl -Lo /tmp/cni-plugins-linux-amd64-v1.1.1.tgz https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz\nmkdir -p /opt/cni/bin\ntar Cxzvf /opt/cni/bin /tmp/cni-plugins-linux-amd64-v1.1.1.tgz\n\n# Remove the temporary files\nrm /tmp/containerd-1.6.9-linux-amd64.tar.gz /tmp/runc.amd64 /tmp/cni-plugins-linux-amd64-v1.1.1.tgz\n\nmkdir /etc/containerd\ncontainerd config default | sudo tee /etc/containerd/config.toml\nsed -i 's/SystemdCgroup \\= false/SystemdCgroup \\= true/g' /etc/containerd/config.toml\n\ncurl -Lo /etc/systemd/system/containerd.service https://raw.githubusercontent.com/containerd/containerd/main/containerd.service\nsystemctl daemon-reload\nsystemctl enable --now containerd\n\n# Kubeadm, Kubelet, and Kubectl\ncurl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg\necho \"deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main\" | sudo tee /etc/apt/sources.list.d/kubernetes.list\napt-get update\napt-get install -y kubelet kubeadm kubectl\napt-mark hold kubelet kubeadm kubectl\n\n# Install Helm 3 for CNI install later\ncurl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3\nchmod 700 get_helm.sh\n./get_helm.sh",
    "kubeadmInit": "#!/bin/sh\nIPADDR=$(hostname -I)\nAPISERVER=$(hostname -s)\nNODENAME=$(hostname -s)\n\nPOD_NET=$1\n\necho \"running kubeadm init --apiserver-advertise-address=$IPADDR \\\n                  --apiserver-cert-extra-sans=$APISERVER \\\n                  --pod-network-cidr=$POD_NET \\\n                  --node-name $NODENAME\"\n\nkubeadm init --apiserver-advertise-address=$IPADDR \\\n             --apiserver-cert-extra-sans=$APISERVER \\\n             --pod-network-cidr=$POD_NET \\\n             --node-name $NODENAME\n\n",
    "cniInstall": "#!/bin/sh\nUSERNAME=$1\nPLUGIN=$2\nCIDR=$3\n\nADMINCONF=/etc/kubernetes/admin.conf\n\nif [ -f \"$ADMINCONF\" ]; then\n        echo \"${ADMINCONF} exists\"\nelse\n        echo \"${ADMINCONF} does not exist\"\n        exit 1\nfi\n\n# Configure kubeconfig for standard user\nmkdir /home/$USERNAME/.kube\ncp -f $ADMINCONF /home/$USERNAME/.kube/config\nchown -v $(id -u $USERNAME):$(id -g $USERNAME) /home/$USERNAME/.kube/config\n\n# install CNI plugin\ncase \"$PLUGIN\" in\n        \"calico\") \n                echo \"Downloading and installing Tigera operator and custom resource defintions ...\"\n                helm repo add projectcalico https://projectcalico.docs.tigera.io/charts\n                KUBECONFIG=$ADMINCONF kubectl create namespace tigera-operator\n                KUBECONFIG=$ADMINCONF helm install calico projectcalico/tigera-operator --version v3.24.5 --namespace tigera-operator\n                ;;\n        *)\n                echo \"Nothing to install\"\n                ;;\nesac",
    "finalizeDeploy": "#!/bin/sh\nNAME=$1\nSAKEY=$2\nSHARENAME=$3\nROLE=$4\n\nmkdir /mnt/share\nif [ ! -d \"/etc/smbcredentials\" ]; then\n    mkdir /etc/smbcredentials\nfi\nif [ ! -f /etc/smbcredentials/smb.cred ]; then\n    bash -c \"echo username=${NAME} >> /etc/smbcredentials/smb.cred\"\n    bash -c \"echo password=${SAKEY} >> /etc/smbcredentials/smb.cred\"\nfi\nchmod 600 /etc/smbcredentials/smb.cred\nmount -t cifs $SHARENAME /mnt/share -o credentials=/etc/smbcredentials/smb.cred,dir_mode=0777,file_mode=0777,serverino -v\n\n# Perform final actions based on the role of the VM\ncase \"$ROLE\" in\n        \"cp\")\n            echo \"Generating a new kubeadm join command\"\n            \n            # Generate a new token\n            TOKEN=$(kubeadm token generate)\n\n            # Use the new token to create the join commnad and save it to the file share\n            kubeadm token create $TOKEN --print-join-command > /mnt/share/joinCommand.txt\n            ;;\n        \"worker\")\n            echo \"Retrieving kubeadm join command\"\n            \n            # Get kubeadm join command\n            COMMAND=$(cat /mnt/share/joinCommand.txt)\n\n            # Run kubebadm join command\n            eval $COMMAND\n            ;;\n        *)\n            echo \"Not a valid role\"\n            exit 1\n            ;;\nesac"
  },
  "resources": [
    {
      "copy": {
        "name": "cse",
        "count": "[length(variables('vmObject'))]"
      },
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "apiVersion": "2022-03-01",
      "name": "[format('{0}/commonfcse', variables('vmObject')[copyIndex()].name)]",
      "location": "[parameters('location')]",
      "properties": {
        "publisher": "Microsoft.Azure.Extensions",
        "type": "CustomScript",
        "typeHandlerVersion": "2.1",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "script": "[base64(variables('commonPrerequisiteConfig'))]"
        }
      },
      "dependsOn": [
        "vms"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "k8s-nsg",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "nsgName": {
            "value": "k8s-nsg"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "nsgProperties": {
            "value": [
              {
                "name": "ssh",
                "priority": 1001,
                "protocol": "tcp",
                "access": "allow",
                "direction": "inbound",
                "destinationPortRange": 22
              },
              {
                "name": "k8s",
                "priority": 1002,
                "protocol": "tcp",
                "access": "allow",
                "direction": "inbound",
                "destinationPortRange": 6443
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "12947668660976139052"
            }
          },
          "parameters": {
            "nsgName": {
              "type": "string"
            },
            "nsgProperties": {
              "type": "array"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2021-02-01",
              "name": "[parameters('nsgName')]",
              "location": "[parameters('location')]",
              "properties": {
                "copy": [
                  {
                    "name": "securityRules",
                    "count": "[length(parameters('nsgProperties'))]",
                    "input": {
                      "name": "[parameters('nsgProperties')[copyIndex('securityRules')].name]",
                      "properties": {
                        "priority": "[parameters('nsgProperties')[copyIndex('securityRules')].priority]",
                        "protocol": "[parameters('nsgProperties')[copyIndex('securityRules')].protocol]",
                        "access": "[parameters('nsgProperties')[copyIndex('securityRules')].access]",
                        "direction": "[parameters('nsgProperties')[copyIndex('securityRules')].direction]",
                        "sourceAddressPrefix": "*",
                        "sourcePortRange": "*",
                        "destinationAddressPrefix": "*",
                        "destinationPortRange": "[parameters('nsgProperties')[copyIndex('securityRules')].destinationPortRange]"
                      }
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "k8s-vnet",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "subnetName": {
            "value": "k8s-subnet"
          },
          "vNetName": {
            "value": "k8s-vnet"
          },
          "vNetAddressPrefix": {
            "value": "10.0.0.0/16"
          },
          "subnetPrefix": {
            "value": "10.0.1.0/27"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "8707486005209017209"
            }
          },
          "parameters": {
            "newOrExisting": {
              "type": "string",
              "defaultValue": "new",
              "allowedValues": [
                "new",
                "existing"
              ],
              "metadata": {
                "description": "Create a new virtual network or use an existing one."
              }
            },
            "vNetName": {
              "type": "string",
              "metadata": {
                "description": "Name of the virtual network to create."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location of the virtual network."
              }
            },
            "vNetAddressPrefix": {
              "type": "string",
              "metadata": {
                "description": "Virtual network address prefix."
              }
            },
            "subnetName": {
              "type": "string",
              "metadata": {
                "description": "Virtual network address prefix."
              }
            },
            "subnetPrefix": {
              "type": "string",
              "metadata": {
                "description": "Subnet address prefix."
              }
            }
          },
          "resources": [
            {
              "condition": "[equals(parameters('newOrExisting'), 'new')]",
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2021-02-01",
              "name": "[parameters('vNetName')]",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vNetAddressPrefix')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "[parameters('subnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('subnetPrefix')]"
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "subnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vNetName'), parameters('subnetName'))]"
            }
          }
        }
      }
    },
    {
      "copy": {
        "name": "pip",
        "count": "[length(variables('vmObject'))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}pip', variables('vmObject')[copyIndex()].name)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "vmName": {
            "value": "[variables('vmObject')[copyIndex()].name]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "2928670114601644409"
            }
          },
          "parameters": {
            "vmName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "variables": {
            "pipName": "[format('{0}pip', parameters('vmName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}pip', parameters('vmName'))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Basic"
              },
              "properties": {
                "publicIPAllocationMethod": "Dynamic",
                "publicIPAddressVersion": "IPv4",
                "dnsSettings": {
                  "domainNameLabel": "[format('{0}{1}', parameters('vmName'), uniqueString(resourceGroup().id))]"
                },
                "idleTimeoutInMinutes": 10
              }
            }
          ],
          "outputs": {
            "pipInfo": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}pip', parameters('vmName')))]",
                "dnsFqdn": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('pipName')), '2021-02-01', 'full').properties.dnsSettings.fqdn]"
              }
            }
          }
        }
      }
    },
    {
      "copy": {
        "name": "nic",
        "count": "[length(variables('vmObject'))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}nic', variables('vmObject')[copyIndex()].name)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'k8s-vnet'), '2025-04-01').outputs.subnetId.value]"
          },
          "netInterfacePrefix": {
            "value": "[variables('vmObject')[copyIndex()].name]"
          },
          "nsgId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'k8s-nsg'), '2025-04-01').outputs.id.value]"
          },
          "publicIPId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}pip', variables('vmObject')[copyIndex()].name)), '2025-04-01').outputs.pipInfo.value.id]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "17105725262581288998"
            }
          },
          "parameters": {
            "netInterfacePrefix": {
              "type": "string",
              "metadata": {
                "description": "Prefix for creating unique names for the network interface."
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID to which the adapter needs to be attached."
              }
            },
            "publicIPId": {
              "type": "string",
              "metadata": {
                "description": "Resource Id of the public IP that will be associated with the network interface."
              }
            },
            "nsgId": {
              "type": "string",
              "metadata": {
                "description": "Resource Id of the network security group that will be associated with the network interface."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location at which this network interface will provisioned."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}nic', parameters('netInterfacePrefix'))]",
              "location": "[parameters('location')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "[format('{0}nicConfig', parameters('netInterfacePrefix'))]",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('subnetId')]"
                      },
                      "privateIPAllocationMethod": "Dynamic",
                      "publicIPAddress": {
                        "id": "[parameters('publicIPId')]"
                      }
                    }
                  }
                ],
                "networkSecurityGroup": {
                  "id": "[parameters('nsgId')]"
                }
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}nic', parameters('netInterfacePrefix')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'k8s-nsg')]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}pip', variables('vmObject')[copyIndex()].name))]",
        "[resourceId('Microsoft.Resources/deployments', 'k8s-vnet')]"
      ]
    },
    {
      "copy": {
        "name": "vms",
        "count": "[length(variables('vmObject'))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[variables('vmObject')[copyIndex()].name]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "passwordOrKey": {
            "value": "[parameters('passwordOrKey')]"
          },
          "username": {
            "value": "[parameters('username')]"
          },
          "vmName": {
            "value": "[variables('vmObject')[copyIndex()].name]"
          },
          "authenticationType": {
            "value": "[parameters('authenticationType')]"
          },
          "nicId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}nic', variables('vmObject')[copyIndex()].name)), '2025-04-01').outputs.id.value]"
          },
          "osOffer": {
            "value": "0001-com-ubuntu-server-focal"
          },
          "osPublisher": {
            "value": "canonical"
          },
          "osVersion": {
            "value": "20_04-lts"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "4787758802525413695"
            }
          },
          "parameters": {
            "vmName": {
              "type": "string",
              "metadata": {
                "description": "Name of the VM to be created."
              }
            },
            "vmSize": {
              "type": "string",
              "defaultValue": "Standard_B2s",
              "metadata": {
                "description": "The size of the VM"
              }
            },
            "nicId": {
              "type": "string",
              "metadata": {
                "description": "Network interface resource Id."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for VM resource."
              }
            },
            "username": {
              "type": "string",
              "metadata": {
                "description": "Username for the VM."
              }
            },
            "osVersion": {
              "type": "string",
              "metadata": {
                "description": "Linux OS version."
              }
            },
            "osOffer": {
              "type": "string",
              "metadata": {
                "description": "Linux OS offer."
              }
            },
            "osPublisher": {
              "type": "string",
              "metadata": {
                "description": "Linux OS publisher"
              }
            },
            "osDiskType": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "metadata": {
                "description": "Disk type for OS disk"
              }
            },
            "authenticationType": {
              "type": "string",
              "defaultValue": "password",
              "allowedValues": [
                "sshPublicKey",
                "password"
              ],
              "metadata": {
                "description": "Type of authentication to use on the Virtual Machine. SSH key is recommended."
              }
            },
            "passwordOrKey": {
              "type": "securestring",
              "metadata": {
                "description": "SSH Key or password for the Virtual Machine. SSH key is recommended."
              }
            }
          },
          "variables": {
            "linuxConfiguration": {
              "disablePasswordAuthentication": true,
              "ssh": {
                "publicKeys": [
                  {
                    "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('username'))]",
                    "keyData": "[parameters('passwordOrKey')]"
                  }
                ]
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2021-11-01",
              "name": "[parameters('vmName')]",
              "location": "[parameters('location')]",
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[parameters('vmSize')]"
                },
                "storageProfile": {
                  "osDisk": {
                    "createOption": "FromImage",
                    "managedDisk": {
                      "storageAccountType": "[parameters('osDiskType')]"
                    }
                  },
                  "imageReference": {
                    "publisher": "[parameters('osPublisher')]",
                    "offer": "[parameters('osOffer')]",
                    "sku": "[parameters('osVersion')]",
                    "version": "latest"
                  }
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[parameters('nicId')]"
                    }
                  ]
                },
                "osProfile": {
                  "computerName": "[parameters('vmName')]",
                  "adminUsername": "[parameters('username')]",
                  "adminPassword": "[parameters('passwordOrKey')]",
                  "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'), null(), variables('linuxConfiguration'))]"
                }
              }
            }
          ],
          "outputs": {
            "vmInfo": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]",
                "name": "[parameters('vmName')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('{0}nic', variables('vmObject')[copyIndex()].name))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "kubeadmInitMrc",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "configType": {
            "value": "kubeadminit"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "vmName": {
            "value": "cplane1"
          },
          "scriptContent": {
            "value": "[variables('kubeadmInit')]"
          },
          "scriptParams": {
            "value": [
              {
                "value": "[parameters('cniCidr')]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "11781053561030946478"
            }
          },
          "parameters": {
            "vmName": {
              "type": "string",
              "metadata": {
                "description": "VM name where this script needs to execute."
              }
            },
            "configType": {
              "type": "string",
              "metadata": {
                "description": "Type of the action performed by this script."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location of the VM."
              }
            },
            "asyncExec": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Should this script be executed asynchronously. Default is false."
              }
            },
            "scriptContent": {
              "type": "string",
              "metadata": {
                "description": "Script content to be executed."
              }
            },
            "scriptParams": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Parameters to pass to the script."
              }
            },
            "protecttedScriptParams": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Protected parameters to pass to the script."
              }
            },
            "timeout": {
              "type": "int",
              "defaultValue": 300,
              "metadata": {
                "description": "Script timeout in seconds. 300 is default."
              }
            }
          },
          "variables": {
            "scriptSource": {
              "script": "[parameters('scriptContent')]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Compute/virtualMachines/runCommands",
              "apiVersion": "2022-08-01",
              "name": "[format('{0}/{1}mrc', parameters('vmName'), parameters('configType'))]",
              "location": "[parameters('location')]",
              "properties": {
                "asyncExecution": "[parameters('asyncExec')]",
                "parameters": "[parameters('scriptParams')]",
                "protectedParameters": "[parameters('protecttedScriptParams')]",
                "source": "[variables('scriptSource')]",
                "timeoutInSeconds": "[parameters('timeout')]"
              }
            }
          ],
          "outputs": {
            "status": {
              "type": "object",
              "value": "[reference(resourceId('Microsoft.Compute/virtualMachines/runCommands', split(format('{0}/{1}mrc', parameters('vmName'), parameters('configType')), '/')[0], split(format('{0}/{1}mrc', parameters('vmName'), parameters('configType')), '/')[1]), '2022-08-01', 'full')]"
            }
          }
        }
      },
      "dependsOn": [
        "cse"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "sa",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "storageAccountName": {
            "value": "[parameters('storageAccountName')]"
          },
          "storageFileShareName": {
            "value": "[parameters('storageFileShareName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "7762424642345192691"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Name for the storage account. This has to be globally unique."
              }
            },
            "storageFileShareName": {
              "type": "string",
              "metadata": {
                "description": "Name for the file share."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location where this storage account needs to be created."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-05-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "kind": "StorageV2",
              "sku": {
                "name": "Standard_LRS"
              },
              "properties": {
                "accessTier": "Cool"
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/default/{1}', parameters('storageAccountName'), parameters('storageFileShareName'))]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            }
          ],
          "outputs": {
            "storage": {
              "type": "object",
              "value": {
                "name": "[parameters('storageAccountName')]",
                "shareUri": "[format('//{0}.file.{1}/{2}', parameters('storageAccountName'), environment().suffixes.storage, parameters('storageFileShareName'))]"
              }
            },
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'kubeadmInitMrc')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "CniInstallMrc",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "configType": {
            "value": "cniInstall"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "vmName": {
            "value": "cplane1"
          },
          "scriptContent": {
            "value": "[variables('cniInstall')]"
          },
          "scriptParams": {
            "value": [
              {
                "value": "[parameters('username')]"
              },
              {
                "value": "[parameters('cniPlugin')]"
              },
              {
                "value": "[parameters('cniCidr')]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "11781053561030946478"
            }
          },
          "parameters": {
            "vmName": {
              "type": "string",
              "metadata": {
                "description": "VM name where this script needs to execute."
              }
            },
            "configType": {
              "type": "string",
              "metadata": {
                "description": "Type of the action performed by this script."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location of the VM."
              }
            },
            "asyncExec": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Should this script be executed asynchronously. Default is false."
              }
            },
            "scriptContent": {
              "type": "string",
              "metadata": {
                "description": "Script content to be executed."
              }
            },
            "scriptParams": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Parameters to pass to the script."
              }
            },
            "protecttedScriptParams": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Protected parameters to pass to the script."
              }
            },
            "timeout": {
              "type": "int",
              "defaultValue": 300,
              "metadata": {
                "description": "Script timeout in seconds. 300 is default."
              }
            }
          },
          "variables": {
            "scriptSource": {
              "script": "[parameters('scriptContent')]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Compute/virtualMachines/runCommands",
              "apiVersion": "2022-08-01",
              "name": "[format('{0}/{1}mrc', parameters('vmName'), parameters('configType'))]",
              "location": "[parameters('location')]",
              "properties": {
                "asyncExecution": "[parameters('asyncExec')]",
                "parameters": "[parameters('scriptParams')]",
                "protectedParameters": "[parameters('protecttedScriptParams')]",
                "source": "[variables('scriptSource')]",
                "timeoutInSeconds": "[parameters('timeout')]"
              }
            }
          ],
          "outputs": {
            "status": {
              "type": "object",
              "value": "[reference(resourceId('Microsoft.Compute/virtualMachines/runCommands', split(format('{0}/{1}mrc', parameters('vmName'), parameters('configType')), '/')[0], split(format('{0}/{1}mrc', parameters('vmName'), parameters('configType')), '/')[1]), '2022-08-01', 'full')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'sa')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "finalizeDeployCP",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "configType": {
            "value": "finalizeDeployCP"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "vmName": {
            "value": "cplane1"
          },
          "scriptContent": {
            "value": "[variables('finalizeDeploy')]"
          },
          "scriptParams": {
            "value": [
              {
                "value": "[parameters('storageAccountName')]"
              },
              {
                "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-05-01').keys[0].value]"
              },
              {
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'sa'), '2025-04-01').outputs.storage.value.shareUri]"
              },
              {
                "value": "cp"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "11781053561030946478"
            }
          },
          "parameters": {
            "vmName": {
              "type": "string",
              "metadata": {
                "description": "VM name where this script needs to execute."
              }
            },
            "configType": {
              "type": "string",
              "metadata": {
                "description": "Type of the action performed by this script."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location of the VM."
              }
            },
            "asyncExec": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Should this script be executed asynchronously. Default is false."
              }
            },
            "scriptContent": {
              "type": "string",
              "metadata": {
                "description": "Script content to be executed."
              }
            },
            "scriptParams": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Parameters to pass to the script."
              }
            },
            "protecttedScriptParams": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Protected parameters to pass to the script."
              }
            },
            "timeout": {
              "type": "int",
              "defaultValue": 300,
              "metadata": {
                "description": "Script timeout in seconds. 300 is default."
              }
            }
          },
          "variables": {
            "scriptSource": {
              "script": "[parameters('scriptContent')]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Compute/virtualMachines/runCommands",
              "apiVersion": "2022-08-01",
              "name": "[format('{0}/{1}mrc', parameters('vmName'), parameters('configType'))]",
              "location": "[parameters('location')]",
              "properties": {
                "asyncExecution": "[parameters('asyncExec')]",
                "parameters": "[parameters('scriptParams')]",
                "protectedParameters": "[parameters('protecttedScriptParams')]",
                "source": "[variables('scriptSource')]",
                "timeoutInSeconds": "[parameters('timeout')]"
              }
            }
          ],
          "outputs": {
            "status": {
              "type": "object",
              "value": "[reference(resourceId('Microsoft.Compute/virtualMachines/runCommands', split(format('{0}/{1}mrc', parameters('vmName'), parameters('configType')), '/')[0], split(format('{0}/{1}mrc', parameters('vmName'), parameters('configType')), '/')[1]), '2022-08-01', 'full')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'CniInstallMrc')]",
        "[resourceId('Microsoft.Resources/deployments', 'sa')]"
      ]
    },
    {
      "copy": {
        "name": "finalizeDeployWorkerMrc",
        "count": "[length(variables('vmObject'))]"
      },
      "condition": "[equals(variables('vmObject')[copyIndex()].role, 'worker')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-finalizeDeployWorker', variables('vmObject')[copyIndex()].name)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "configType": {
            "value": "finalizeDeployWorker"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "vmName": {
            "value": "[variables('vmObject')[copyIndex()].name]"
          },
          "scriptContent": {
            "value": "[variables('finalizeDeploy')]"
          },
          "scriptParams": {
            "value": [
              {
                "value": "[parameters('storageAccountName')]"
              },
              {
                "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-05-01').keys[0].value]"
              },
              {
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'sa'), '2025-04-01').outputs.storage.value.shareUri]"
              },
              {
                "value": "worker"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "11781053561030946478"
            }
          },
          "parameters": {
            "vmName": {
              "type": "string",
              "metadata": {
                "description": "VM name where this script needs to execute."
              }
            },
            "configType": {
              "type": "string",
              "metadata": {
                "description": "Type of the action performed by this script."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location of the VM."
              }
            },
            "asyncExec": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Should this script be executed asynchronously. Default is false."
              }
            },
            "scriptContent": {
              "type": "string",
              "metadata": {
                "description": "Script content to be executed."
              }
            },
            "scriptParams": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Parameters to pass to the script."
              }
            },
            "protecttedScriptParams": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Protected parameters to pass to the script."
              }
            },
            "timeout": {
              "type": "int",
              "defaultValue": 300,
              "metadata": {
                "description": "Script timeout in seconds. 300 is default."
              }
            }
          },
          "variables": {
            "scriptSource": {
              "script": "[parameters('scriptContent')]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Compute/virtualMachines/runCommands",
              "apiVersion": "2022-08-01",
              "name": "[format('{0}/{1}mrc', parameters('vmName'), parameters('configType'))]",
              "location": "[parameters('location')]",
              "properties": {
                "asyncExecution": "[parameters('asyncExec')]",
                "parameters": "[parameters('scriptParams')]",
                "protectedParameters": "[parameters('protecttedScriptParams')]",
                "source": "[variables('scriptSource')]",
                "timeoutInSeconds": "[parameters('timeout')]"
              }
            }
          ],
          "outputs": {
            "status": {
              "type": "object",
              "value": "[reference(resourceId('Microsoft.Compute/virtualMachines/runCommands', split(format('{0}/{1}mrc', parameters('vmName'), parameters('configType')), '/')[0], split(format('{0}/{1}mrc', parameters('vmName'), parameters('configType')), '/')[1]), '2022-08-01', 'full')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'finalizeDeployCP')]",
        "[resourceId('Microsoft.Resources/deployments', 'sa')]"
      ]
    }
  ],
  "outputs": {
    "vmInfo": {
      "type": "array",
      "copy": {
        "count": "[length(variables('vmObject'))]",
        "input": {
          "name": "[variables('vmObject')[copyIndex()].name]",
          "connect": "[format('ssh {0}@{1}', parameters('username'), reference(resourceId('Microsoft.Resources/deployments', format('{0}pip', variables('vmObject')[copyIndex()].name)), '2025-04-01').outputs.pipInfo.value.dnsFqdn)]"
        }
      }
    }
  }
}