{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "14887719505442757099"
    }
  },
  "variables": {
    "templateSpecName": "nsg",
    "templateSpecDisplayName": "Azure Network Security Group",
    "templateSpecVersion": "1.0.0",
    "templateSpecDescription": "Creates an Azure Network Security Group",
    "templateSpecJson": "{\r\n  \"$schema\": \"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#\",\r\n  \"contentVersion\": \"1.0.0.0\",\r\n  \"metadata\": {\r\n    \"_generator\": {\r\n      \"name\": \"bicep\",\r\n      \"version\": \"0.4.1124.51302\",\r\n      \"templateHash\": \"3554013795371139531\"\r\n    }\r\n  },\r\n  \"parameters\": {\r\n    \"nsgPrefix\": {\r\n      \"type\": \"string\"\r\n    },\r\n    \"nsgProperties\": {\r\n      \"type\": \"array\"\r\n    }\r\n  },\r\n  \"resources\": [\r\n    {\r\n      \"type\": \"Microsoft.Network/networkSecurityGroups\",\r\n      \"apiVersion\": \"2021-02-01\",\r\n      \"name\": \"[format('{0}-nsg', parameters('nsgPrefix'))]\",\r\n      \"location\": \"[resourceGroup().location]\",\r\n      \"properties\": {\r\n        \"copy\": [\r\n          {\r\n            \"name\": \"securityRules\",\r\n            \"count\": \"[length(parameters('nsgProperties'))]\",\r\n            \"input\": {\r\n              \"name\": \"[parameters('nsgProperties')[copyIndex('securityRules')].name]\",\r\n              \"properties\": {\r\n                \"priority\": \"[parameters('nsgProperties')[copyIndex('securityRules')].priority]\",\r\n                \"protocol\": \"[parameters('nsgProperties')[copyIndex('securityRules')].protocol]\",\r\n                \"access\": \"[parameters('nsgProperties')[copyIndex('securityRules')].access]\",\r\n                \"direction\": \"[parameters('nsgProperties')[copyIndex('securityRules')].direction]\",\r\n                \"sourceAddressPrefix\": \"*\",\r\n                \"sourcePortRange\": \"*\",\r\n                \"destinationAddressPrefix\": \"*\",\r\n                \"destinationPortRange\": \"[parameters('nsgProperties')[copyIndex('securityRules')].destinationPortRange]\"\r\n              }\r\n            }\r\n          }\r\n        ]\r\n      }\r\n    }\r\n  ],\r\n  \"outputs\": {\r\n    \"id\": {\r\n      \"type\": \"string\",\r\n      \"value\": \"[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-nsg', parameters('nsgPrefix')))]\"\r\n    }\r\n  }\r\n}",
    "location": "[resourceGroup().location]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('templateSpecName')]",
      "location": "[variables('location')]",
      "properties": {
        "description": "[variables('templateSpecDescription')]",
        "displayName": "[variables('templateSpecDisplayName')]"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[format('{0}/{1}', variables('templateSpecName'), variables('templateSpecVersion'))]",
      "location": "[variables('location')]",
      "properties": {
        "mainTemplate": "[json(variables('templateSpecJson'))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('templateSpecName'))]"
      ]
    }
  ],
  "outputs": {
    "templateSpecUri": {
      "type": "string",
      "value": "[format('ts:{0}/{1}/{2}:{3}', subscription().subscriptionId, resourceGroup().name, variables('templateSpecName'), variables('templateSpecVersion'))]"
    }
  }
}